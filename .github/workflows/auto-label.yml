name: Auto Label PRs

on:
  pull_request_target:
    types: [opened, synchronize]

permissions:
  contents: read
  pull-requests: write

jobs:
  label:
    runs-on: ubuntu-latest
    steps:
      - name: Label based on changed files
        uses: actions/labeler@v5
        with:
          repo-token: "${{ secrets.GITHUB_TOKEN }}"
          configuration-path: .github/labeler.yml
          sync-labels: true

      - name: Label for language
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });

            const labels = [];
            const fileExtensions = files.map(f => {
              const parts = f.filename.split('.');
              return parts.length > 1 ? parts[parts.length - 1].toLowerCase() : '';
            });

            // Language detection
            if (fileExtensions.some(ext => ['py'].includes(ext))) labels.push('python');
            if (fileExtensions.some(ext => ['js', 'jsx'].includes(ext))) labels.push('javascript');
            if (fileExtensions.some(ext => ['ts', 'tsx'].includes(ext))) labels.push('typescript');
            if (fileExtensions.some(ext => ['java'].includes(ext))) labels.push('java');
            if (fileExtensions.some(ext => ['cpp', 'cc', 'cxx'].includes(ext))) labels.push('cpp');
            if (fileExtensions.some(ext => ['c'].includes(ext))) labels.push('c');
            if (fileExtensions.some(ext => ['go'].includes(ext))) labels.push('go');
            if (fileExtensions.some(ext => ['rs'].includes(ext))) labels.push('rust');
            if (fileExtensions.some(ext => ['rb'].includes(ext))) labels.push('ruby');
            if (fileExtensions.some(ext => ['php'].includes(ext))) labels.push('php');
            if (fileExtensions.some(ext => ['sh', 'bash'].includes(ext))) labels.push('bash');
            if (fileExtensions.some(ext => ['html', 'css'].includes(ext))) labels.push('web');

            // Documentation detection
            if (fileExtensions.some(ext => ['md'].includes(ext))) labels.push('documentation');

            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: labels
              });
            }
